#  1

```
class SceneDelegate: UIResponder, UIWindowSceneDelegate {

    var window: UIWindow?

    func scene(_ scene: UIScene, willConnectTo session: UISceneSession, options connectionOptions: UIScene.ConnectionOptions) {
        guard let windowScene = (scene as? UIWindowScene) else { return }
        window = UIWindow(windowScene: windowScene)
        window?.rootViewController = HomeViewController()
        window?.makeKeyAndVisible()
    }
}
```
Store.swift
```
import Combine
import SwiftUI

typealias Bag = Set<AnyCancellable>
typealias Callback = () -> Void

class Store<Event, Action> {
    private(set) var events = PassthroughSubject<Event, Never>()
    private(set) var actions = PassthroughSubject<Action, Never>()

    var bag = Bag()

    init() {
        setupActionHandlers()
    }

    func sendAction(_ action: Action) {
        actions.send(action)
    }

    func sendEvent(_ event: Event) {
        events.send(event)
    }

    func setupActionHandlers() {
        actions.sink { [weak self] action in
            guard let self else { return }
            self.handleActions(action: action)
        }.store(in: &bag)
    }

    func handleActions(action: Action) {}

    func statefulCall(_ action: @MainActor @escaping () async throws -> ()) {
        Task { try await action() }
    }
}
```
HomeStore.swift
```
import Foundation

enum HomeEvent {
    case didLoad(String)
}

enum HomeAction {
    case fetch
}

final class HomeStore: Store<HomeEvent, HomeAction> {
    override func handleActions(action: HomeAction) {
        switch action {
        case .fetch:
            statefulCall {
                weak var wSelf = self
                try await wSelf?.fetch()
            }
        }
    }
    
    private func fetch() async throws {
        sendEvent(.didLoad("Title"))
    }
}
```
HomeViewController.swift
```
import UIKit

class HomeViewController: UIViewController {
    private let store = HomeStore()
    var bag = Bag()
    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .systemBackground
        store.sendAction(.fetch)
        setupObservers()
    }
    
    private func setupObservers() {
        store
            .events
            .receive(on: DispatchQueue.main)
            .sink { [weak self] event in
                guard let self = self else { return }
                switch event {
                case let .didLoad(title):
                    self.printTitle(title)
                }
            }.store(in: &bag)
    }
    
    private func printTitle(_ title: String) {
        print(title)
    }
}
```
BaseViewController.swift
```
import UIKit

class BaseViewController: UIViewController {
    var bag = Bag()
    deinit {
        print("\(String(describing: self)) dealloc" )
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupViews()
        setupConstraints()
        setupObservers()
    }
}

@objc extension BaseViewController {
    func setupViews() {
        view.backgroundColor = .systemBackground
    }
    func setupConstraints() {}
    func setupObservers() {}
}
```
[Netflix UI Kit](https://www.figma.com/file/Nb7tDBAey5Vr1EUiNSa5lt/Netflix-UI-Kit-(Mobile-iOS))
[Netflix App](https://www.figma.com/file/D7oXMkCzqMGaKgIHO715HV/Netflix-App-(Community))
[Top Rated](https://developer.themoviedb.org/reference/movie-top-rated-list)
![](/Docs/img/01.png)

[QuickType](https://app.quicktype.io/)

[How to build an image URL](https://developer.themoviedb.org/docs/image-basics)
```
https://image.tmdb.org/t/p/w500/1E5baAaEse26fej7uHcjOgEE2t2.jpg
```

Movie.swift
```
struct Movie: Codable, Hashable {
    let id: Int
    let adult: Bool
    let backdropPath: String
    let genreIds: [Int]
    let originalLanguage: String
    let originalTitle: String
    let overview: String
    let popularity: Double
    let posterPath: String
    let releaseDate: String
    let title: String
    let video: Bool
    let voteAverage: Double
    let voteCount: Int
    var posterUrl: String {
        "https://image.tmdb.org/t/p/w500\(posterPath)"
    }
}
```
[Movies.json](https://raw.githubusercontent.com/VladimirFibe/Netflix/develop/Netflix/Movies.json)

Bundle+Decoder.swift
```
extension Bundle {
    func decode<T: Decodable>(_ type: T.Type, from file: String) -> T {
        guard let url = self.url(forResource: file, withExtension: nil)
        else { fatalError("Failed to locate \(file) in bundle.") }
        
        guard let data = try? Data(contentsOf: url)
        else { fatalError("Failed to load \(file) from bundle.")}
        
        let decoder = JSONDecoder()
        decoder.keyDecodingStrategy = .convertFromSnakeCase
        guard let loaded = try? decoder.decode(T.self, from: data) else
        { fatalError("Failed to decode \(file) from bundle.")}
        
        return loaded
    }
}
```
HomeSection.swift
```
struct HomeSection: Hashable {
    let id = UUID().uuidString
    let title: String?
    let movies: [Movie]
}
```
HomeStore.swift
```
import Foundation

enum HomeEvent {
    case didLoad([HomeSection])
}

enum HomeAction {
    case fetch
}

final class HomeStore: Store<HomeEvent, HomeAction> {
    override func handleActions(action: HomeAction) {
        switch action {
        case .fetch:
            statefulCall {
                weak var wSelf = self
                try await wSelf?.fetch()
            }
        }
    }
    
    private func fetch() async throws {
        let movies = Bundle.main.decode([Movie].self, from: "Movies.json")
        let sections = [
            HomeSection(title: nil, movies: Array(movies[0...0])),
            HomeSection(title: "Trending Moviews", movies: Array(movies[1...4])),
            HomeSection(title: "Trending TV", movies: Array(movies[5...8])),
            HomeSection(title: "Popular", movies: Array(movies[9...11])),
            HomeSection(title: "Upcoming Movies", movies: Array(movies[12...14])),
            HomeSection(title: "Top rated", movies: Array(movies[15...19]))
        ]
        sendEvent(.didLoad(sections))
    }
}
```

```
class HomeViewController: BaseViewController {
    private var sections: [HomeSection] = []
    private let store = HomeStore()
    private func reloadData() {
        print(sections[0].movies[0].posterUrl)
    }
}
// MARK: - Setup Views
extension HomeViewController {
    override func setupViews() {
        store.sendAction(.fetch)
    }
    override func setupObservers() {
        store
            .events
            .receive(on: DispatchQueue.main)
            .sink { [weak self] event in
                guard let self = self else { return }
                switch event {
                case let .didLoad(sections):
                    self.sections = sections
                    self.reloadData()
                }
            }.store(in: &bag)
    }
}
```
Добавим
```
private typealias DataSource = UICollectionViewDiffableDataSource<HomeSection, Movie>
private typealias Snapshot = NSDiffableDataSourceSnapshot<HomeSection, Movie>
```

```
    private var dataSource: DataSource!
    private var collectionView: UICollectionView!
```
SelfConfiguringMovieCell.swift
```
protocol SelfConfiguringMovieCell {
  static var identifier: String { get }
    func configure(with movie: Movie)
}
```
BaseCollectionViewCell.swift
```
import UIKit

class BaseCollectionViewCell: UICollectionViewCell {
    override init(frame: CGRect) {
        super.init(frame: frame)
        setupViews()
        setupConstraints()
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
}

@objc extension BaseCollectionViewCell {
    func setupViews() {}
    func setupConstraints() {}
}
```
FileStorage.swift
```
final class FileStorage {
    static func downloadImage(link: String, completion: @escaping (UIImage?) -> Void) {
        let fileName = String(link.split(separator: "/").last ?? "name")
        if let image = UIImage(contentsOfFile: fileInDocumetsDirectory(fileName: fileName)) {
            completion(image)
        } else if let url = URL(string: link) {
            let downloadQueue = DispatchQueue(label: "imageDownloadQueue")
            downloadQueue.async {
                if let data = NSData(contentsOf: url) {
                    saveFileLocally(data, fileName: fileName)
                    DispatchQueue.main.async {
                        completion(UIImage(data: data as Data))
                    }
                } else {
                    DispatchQueue.main.async {
                        completion(nil)
                    }
                }
            }
        } else {
            completion(nil)
        }
    }

    static func saveFileLocally(_ fileData: NSData, fileName: String) {
        let docUrl = getDocumentsURL().appendingPathComponent(fileName, isDirectory: false)
        fileData.write(to: docUrl, atomically: true)
    }

    static func saveImageLocally(_ image: UIImage, fileName: String) {
        guard let data = image.jpegData(compressionQuality: 1.0) as? NSData else { return }
        saveFileLocally(data, fileName: fileName)
    }

    static func getDocumentsURL() -> URL {
        FileManager.default.urls(for: .documentDirectory, in: .userDomainMask).last!
    }

    static func fileInDocumetsDirectory(fileName: String) -> String {
        getDocumentsURL().appendingPathComponent(fileName).path
    }

    static func fileExistsAtPath(_ path: String) -> Bool {
        FileManager.default.fileExists(atPath: fileInDocumetsDirectory(fileName: path))
    }
}
```
HomeHeroCell.swift
```
final class HomeHeroCell: BaseCollectionViewCell, SelfConfiguringMovieCell {
    static var identifier = "HomeHeroCell"
    private let posterImageView: UIImageView = {
        $0.contentMode = .scaleAspectFill
        $0.clipsToBounds = true
        $0.backgroundColor = .systemGray4
        return $0
    }(UIImageView())
    
    func configure(with movie: Movie) {
        FileStorage.downloadImage(link: movie.posterUrl) { image in
            self.posterImageView.image = image
        }
    }
    
    override func setupViews() {
        contentView.addSubview(posterImageView)
    }
    
    override func layoutSubviews() {
        super.layoutSubviews()
        posterImageView.frame = contentView.bounds
    }
}
```
для проверки добавил
```
    private let hero = HomeHeroCell()
    private func reloadData() {
        hero.configure(with: sections[0].movies[0])
    }
```

```
    override func setupViews() {
        store.sendAction(.fetch)
        view.addSubview(hero)
        hero.translatesAutoresizingMaskIntoConstraints = false
    }
    
    override func setupConstraints() {
        NSLayoutConstraint.activate([
            hero.topAnchor.constraint(equalTo: view.topAnchor),
            hero.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            hero.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            hero.heightAnchor.constraint(equalToConstant: 500)
        ])
    }

```

```
    func configure<T: SelfConfiguringMovieCell>(_ cellType: T.Type, 
                                                wiht movie: Movie,
                                                for indexPath: IndexPath) -> T {
      guard let cell = collectionView.dequeueReusableCell(
        withReuseIdentifier: cellType.identifier,
        for: indexPath) as? T else { fatalError("Unable to dequeue \(cellType)")}
      cell.configure(with: movie)
      return cell
    }
```

```
    private func configureDataSource() {
        dataSource = DataSource(collectionView: collectionView) { collectionView, indexPath, movie in
            return self.configure(HomeHeroCell.self, wiht: movie, for: indexPath)
        }
    }
```

```
    private func reloadData() {
        var snapshot = Snapshot()
        snapshot.appendSections(sections)
        sections.forEach {
            snapshot.appendItems($0.movies, toSection: $0)
        }
        dataSource.apply(snapshot, animatingDifferences: false)
    }
```

```
    private lazy var collectionView: UICollectionView = {
        let collectionView = UICollectionView(frame: .zero, collectionViewLayout: UICollectionViewFlowLayout())
        collectionView.register(HomeHeroCell.self, forCellWithReuseIdentifier: HomeHeroCell.identifier)
        return collectionView
    }()
```


```
    override func viewDidLayoutSubviews() {
        super.viewDidLayoutSubviews()
        collectionView.frame = view.bounds
    }
```

```
    override func setupViews() {
        store.sendAction(.fetch)
        view.addSubview(collectionView)
        configureDataSource()
    }
```
Запускаем:
![](/Docs/img/02.png)

```
    func createHeroSection(using section: HomeSection) -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1),
            heightDimension: .fractionalHeight(1)
        )
        let layoutItem = NSCollectionLayoutItem(layoutSize: itemSize)
        
        let layoutGroupSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1),
            heightDimension: .absolute(500)
        )
        let layoutGroup = NSCollectionLayoutGroup.horizontal(layoutSize: layoutGroupSize, subitems: [layoutItem])
        
        let layoutSection = NSCollectionLayoutSection(group: layoutGroup)
        layoutSection.orthogonalScrollingBehavior = .continuous
        return layoutSection
    }
```

```
    func createCompositionalLayout() -> UICollectionViewLayout {
        let layout = UICollectionViewCompositionalLayout { index, environment in
            self.createHeroSection(using: self.sections[index])
        }
        let config = UICollectionViewCompositionalLayoutConfiguration()
        config.interSectionSpacing = 20
        layout.configuration = config
        return layout
    }
```

```
    private lazy var collectionView: UICollectionView = {
        let collectionView = UICollectionView(frame: .zero, collectionViewLayout: createCompositionalLayout())
        collectionView.register(HomeHeroCell.self, forCellWithReuseIdentifier: HomeHeroCell.identifier)
        return collectionView
    }()

```

```
final class HomeMovieCell: BaseCollectionViewCell, SelfConfiguringMovieCell {
    static var identifier = "HomeMovieCell"
    private let posterImageView: UIImageView = {
        $0.contentMode = .scaleAspectFill
        $0.clipsToBounds = true
        $0.backgroundColor = .systemGray4
        return $0
    }(UIImageView())
    
    func configure(with movie: Movie) {
        FileStorage.downloadImage(link: movie.posterUrl) { image in
            self.posterImageView.image = image
        }
    }
    
    override func setupViews() {
        contentView.addSubview(posterImageView)
    }
    
    override func layoutSubviews() {
        super.layoutSubviews()
        posterImageView.frame = contentView.bounds
    }
}
```
```
    func createMovieSection(using section: HomeSection) -> NSCollectionLayoutSection {
        let itemSize = NSCollectionLayoutSize(
            widthDimension: .absolute(100),
            heightDimension: .absolute(150)
        )
        let layoutItem = NSCollectionLayoutItem(layoutSize: itemSize)
        layoutItem.contentInsets.trailing = 8
        let layoutGroupSize = NSCollectionLayoutSize(
            widthDimension: .estimated(350),
            heightDimension: .absolute(150)
        )
        let layoutGroup = NSCollectionLayoutGroup.horizontal(layoutSize: layoutGroupSize, subitems: [layoutItem])
        layoutGroup.interItemSpacing = .fixed(8)
        let layoutSection = NSCollectionLayoutSection(group: layoutGroup)
        layoutSection.orthogonalScrollingBehavior = .continuous
        return layoutSection
    }
```

```
        let layout = UICollectionViewCompositionalLayout { index, environment in
            if index == 0 {
                self.createHeroSection(using: self.sections[index])
            } else {
                self.createMovieSection(using: self.sections[index])
            }
        }
```

```
        dataSource = DataSource(collectionView: collectionView) { collectionView, indexPath, movie in
            if indexPath.section == 0 {
                return self.configure(HomeHeroCell.self, wiht: movie, for: indexPath)
            } else {
                return self.configure(HomeMovieCell.self, wiht: movie, for: indexPath)
            }
        }
```

```
        collectionView.register(HomeMovieCell.self, forCellWithReuseIdentifier: HomeMovieCell.identifier)
```

```
class BaseCollectionReusableView: UICollectionReusableView {
    override init(frame: CGRect) {
        super.init(frame: frame)
        setupViews()
        setupConstraints()
    }
    
    required init?(coder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
}

@objc extension BaseCollectionReusableView {
    func setupViews() {}
    func setupConstraints() {}
}
```
```
final class HomeSectionHeader: BaseCollectionReusableView {
    static let identifier = "HomeSectionHeader"
    private let label: UILabel = {
        $0.text = "Title"
        $0.translatesAutoresizingMaskIntoConstraints = false
        $0.adjustsFontForContentSizeCategory = true
        $0.textColor = .label
        $0.font = .systemFont(ofSize: 18, weight: .semibold)
        return $0
    }(UILabel())
    
    func configure(with text: String?) {
        label.text = text
    }
}

extension HomeSectionHeader {
    override func setupViews() {
        addSubview(label)
    }
    
    override func setupConstraints() {
        NSLayoutConstraint.activate([
            label.topAnchor.constraint(equalToSystemSpacingBelow: topAnchor, multiplier: 1),
            label.leadingAnchor.constraint(equalToSystemSpacingAfter: leadingAnchor, multiplier: 2),
            trailingAnchor.constraint(equalToSystemSpacingAfter: label.trailingAnchor, multiplier: 1),
            bottomAnchor.constraint(equalToSystemSpacingBelow: label.bottomAnchor, multiplier: 1)
        ])
    }
}
```

```
        collectionView.register(HomeSectionHeader.self,
                                forSupplementaryViewOfKind: UICollectionView.elementKindSectionHeader,
                                withReuseIdentifier: HomeSectionHeader.identifier)
```

```
        dataSource.supplementaryViewProvider = { [weak self] collectionView, kind, indexPath in
            guard let self,
                  let title = sections[indexPath.section].title,
                  let sectionHeader = collectionView.dequeueReusableSupplementaryView(
                    ofKind: kind,
                    withReuseIdentifier: HomeSectionHeader.identifier,
                    for: indexPath
                  ) as? HomeSectionHeader else { return nil }
            sectionHeader.configure(with: title)
            return sectionHeader
        }
```
```
        let layoutSectionHeaderSize = NSCollectionLayoutSize(
            widthDimension: .fractionalWidth(1),
            heightDimension: .estimated(20)
        )
        let layoutSectionHeader = NSCollectionLayoutBoundarySupplementaryItem(
            layoutSize: layoutSectionHeaderSize,
            elementKind: UICollectionView.elementKindSectionHeader,
            alignment: .top
        )
        layoutSection.boundarySupplementaryItems = [layoutSectionHeader]
```
```
```
```
```
